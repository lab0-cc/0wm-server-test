name: Nightly Nix testing
on:
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:
jobs:
  pre:
    name: Check if the jobs needs to be run
    runs-on: ubuntu-latest
    outputs:
      should_skip: ${{ steps.skip_check.outputs.should_skip }}
    steps:
      - id: skip_check
        uses: fkirc/skip-duplicate-actions@v5
        with:
          paths_ignore: '[".github/**"]'
          do_not_skip: '["workflow_dispatch"]'
  test-nix:
    name: Test for ${{ matrix.arch.name }} (${{ matrix.arch.os }})
    runs-on: ${{ matrix.arch.os }}
    strategy:
      fail-fast: false
      matrix:
        arch:
          - { name: amd64-linux, os: ubuntu-latest }
          - { name: arm64-linux, os: ubuntu-24.04-arm }
          - { name: arm64-darwin, os: macos-latest }
    needs: pre
    if: needs.pre.outputs.should_skip != 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Install Nix
        uses: cachix/install-nix-action@v31
      - name: Build 0WM and test
        run: nix develop --command bash -c 'dune test --instrument-with bisect_ppx --profile release && bisect-ppx-report cobertura coverage.xml'
      - name: Setup .NET Core
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.x
          dotnet-quality: 'ga'
        if: matrix.arch.os == 'ubuntu-latest'
      - name: Generate coverage report
        uses: danielpalme/ReportGenerator-GitHub-Action@5.5.1
        with:
          reports: coverage.xml
          targetdir: coverage
          reporttypes: Markdown
        if: matrix.arch.os == 'ubuntu-latest'
      - name: Coverage summary
        run: cat coverage/Summary.md >> $GITHUB_STEP_SUMMARY
        if: matrix.arch.os == 'ubuntu-latest'
